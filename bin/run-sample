#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler/setup'
require 'pathname'
$LOAD_PATH.unshift(Pathname.new(__FILE__).dirname.dirname.join('lib').to_s)

require 'yaml'
require 'test_summary_buildkite_plugin'

TestSummaryBuildkitePlugin::Agent.stub = true

pipeline_sample = YAML.load_file('.buildkite/pipeline-sample.yml')

pipeline_sample['steps'].each do |step|
  next unless step['plugins']

  # Match the formatting that buildkite gives
  ENV['BUILDKITE_PLUGINS'] = [step['plugins']].to_json
  TestSummaryBuildkitePlugin.run
end
